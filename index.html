<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Weihnachtsgeschenk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* === Farbanpassungen f√ºr einen modernen, cleanen Look === */
        :root{
            --red-primary:#b40000;      /* Tiefrot */
            --gold-muted:#C7A868;       /* Mattes Champagner-Gold */
            --silver:#E0E0E0;           /* Helles Silber f√ºr Schnee/Akzente */
            --blue-chat:#3b82f6;        /* Helles Blau f√ºr Chat (Me) */
            --red-chat:#dc2626;         /* Klassisches Rot f√ºr Chat (Other - Bilbo) */
            --bg-dark:#091a38;          /* Sehr dunkles, tiefes Blau */
        }
        
        /* Basis-Animationen / Styles */
        @keyframes shake {0%,100%{transform:rotate(0deg)}25%{transform:rotate(-3deg)}75%{transform:rotate(3deg)}} /* Sanfteres Sch√ºtteln */
        @keyframes openGift {0%{transform:rotateX(0deg)}100%{transform:rotateX(-120deg)}}
        @keyframes openBowLeft {0%{transform:translate(0,0) rotate(-12deg)}100%{transform:translate(-60px,-20px) rotate(-45deg);opacity:0}}
        @keyframes openBowRight {0%{transform:translate(0,0) rotate(12deg)}100%{transform:translate(60px,-20px) rotate(45deg);opacity:0}}
        @keyframes openBowCenter {0%{transform:translate(-50%,-50%) rotate(45deg) scale(1)}100%{transform:translate(-50%,-50%) rotate(45deg) scale(0);opacity:0}}
        @keyframes fall {0% { transform: translateY(-10vh); } 100% { transform: translateY(110vh); }}
        
        /* Cleaner Hintergrund: Nur tiefe Farbe, kein starkes Glitzer-Overlay */
        body{ background: var(--bg-dark); position:relative; overflow:hidden; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
        body::before{ display: none; } /* Glitzer entfernt */

        /* Geschenk-Styles: Cleaner, weniger Muster, tiefe Farbe */
        .gift-pattern{ background-image: none; } 
        #gift-lid > div, #gift-box {
            background-color: var(--red-primary); 
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.2) 100%), var(--red-primary); 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
            border: 1px solid rgba(255,255,255,0.05); 
        }
        /* Mattes Metallic-Band */
        .ribbon-shine, .bow-shine{ 
            background: var(--gold-muted); 
            box-shadow: 0 0 10px rgba(0,0,0,0.2); 
        }

        .snowflake{ position:absolute; background:var(--silver); border-radius:50%; pointer-events:none; animation: fall linear forwards; opacity:0.85; }
        
        /* Verbessertes Glassmorphismus */
        .glass{ 
            background: rgba(255,255,255,0.05); 
            backdrop-filter: blur(12px); 
            border:1px solid rgba(255,255,255,0.05); 
        }

        .confetti{ position:fixed; pointer-events:none; transform-origin:center; will-change: transform, opacity; }

        /* Musik-Button (Z-INDEX KORREKTUR) */
        .music-control{
            position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:40; /* Reduziert von 120 auf 40, damit Chat (z-50) dar√ºber liegt */
            display:flex; align-items:center; gap:10px;
            background: rgba(0,0,0,0.45); padding:10px 14px; border-radius:999px;
            backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,0.08); box-shadow:0 8px 30px rgba(0,0,0,0.45);
        }
        .music-btn{ width:48px; height:48px; display:grid; place-items:center; border-radius:999px; background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01)); cursor:pointer; border:1px solid rgba(255,255,255,0.06);}
        .music-title{ color:#fff; font-weight:600; font-size:13px; white-space:nowrap; max-width:200px; overflow:hidden; text-overflow:ellipsis;}
        .music-state{ color:#e6e6e6; font-size:12px; opacity:0.9; }
        @media (max-width:420px){ .music-title{ display:none; } .music-control{ padding:8px; bottom:12px; } }

        .open-lid{ animation: openGift 0.6s ease-out forwards; transform-origin: bottom; }
        .open-bow-left{ animation: openBowLeft 0.5s ease-out forwards; }
        .open-bow-right{ animation: openBowRight 0.5s ease-out forwards; }
        .open-bow-center{ animation: openBowCenter 0.5s ease-out forwards; }
        
        /* === CHAT STYLES === */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }

        .chat-bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 20px;
            color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.25);
            position: relative;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInBubble 0.3s ease-out forwards;
            font-weight: 500;
        }

        .bubble-me {
            background-color: var(--blue-chat); 
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .bubble-other {
            background-color: var(--red-chat); 
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        @keyframes fadeInBubble {
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">

    <div class="fixed top-4 left-0 right-0 flex justify-center gap-6 z-0 pointer-events:none">
        </div>
    <div class="fixed left-4 bottom-8 opacity-20"><div class="tree relative"><div class="tree-trunk"></div></div></div>
    <div class="fixed right-4 bottom-8 opacity-20"><div class="tree relative"><div class="tree-trunk"></div></div></div>

    <div class="text-center relative z-10 px-4">
        <div id="gift-container" class="relative cursor-pointer perspective-1000 transition-all duration-800 ease-out" onclick="openGift()">
            <div id="gift-lid" class="relative z-10 mb-1 sm:mb-2">
                <div class="w-40 h-14 sm:w-56 sm:h-20 rounded-t-lg mx-auto shadow-2xl gift-pattern border-2 sm:border-4 border-red-800 relative overflow-visible">
                    <div class="absolute top-1 left-2 w-14 h-6 sm:top-2 sm:left-4 sm:w-20 sm:h-8 bg-white opacity-20 rounded-full blur-sm"></div>
                    <div class="absolute top-1/2 left-0 right-0 h-4 sm:h-6 ribbon-shine transform -translate-y-1/2 shadow-lg border-t border-b sm:border-t-2 sm:border-b-2 border-yellow-600 z-10"></div>
                    <div class="absolute top-1/2 left-0 right-0 h-0.5 sm:h-1 bg-yellow-300 transform -translate-y-1/2 z-10"></div>
                    <div class="absolute top-0 bottom-0 left-1/2 w-4 sm:w-6 ribbon-shine transform -translate-x-1/2 shadow-lg border-l border-r sm:border-l-2 sm:border-r-2 border-yellow-600 z-10"></div>
                    <div class="absolute top-0 bottom-0 left-1/2 w-0.5 sm:w-1 bg-yellow-300 transform -translate-x-1/2 z-10"></div>

                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20">
                        <div id="bow-center" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 rotate-45 z-30 w-5 h-5 sm:w-8 sm:h-8 bow-shine rounded shadow-xl border border-yellow-600 sm:border-2"></div>
                        <div id="bow-left" class="absolute top-1/2 left-1/2 transform -translate-y-1/2 -translate-x-full -rotate-12">
                            <div class="w-8 h-8 sm:w-12 sm:h-12 bow-shine rounded-full shadow-xl border border-yellow-600 sm:border-2 -ml-1 sm:-ml-2"></div>
                        </div>
                        <div id="bow-right" class="absolute top-1/2 left-1/2 transform -translate-y-1/2 rotate-12">
                            <div class="w-8 h-8 sm:w-12 sm:h-12 bow-shine rounded-full shadow-xl border border-yellow-600 sm:border-2 -mr-1 sm:-mr-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gift-box" class="w-40 h-40 sm:w-56 sm:h-56 mx-auto shadow-2xl rounded-b-lg relative gift-pattern border-2 sm:border-4 border-red-800 z-20">
                <div class="absolute top-2 left-3 w-16 h-20 sm:top-4 sm:left-6 sm:w-24 sm:h-32 bg-white opacity-20 rounded-full blur-md"></div>
                <div class="absolute top-0 bottom-0 left-1/2 w-5 sm:w-8 ribbon-shine transform -translate-x-1/2 shadow-lg border-l border-r sm:border-l-2 sm:border-r-2 border-yellow-600"></div>
                <div class="absolute top-0 bottom-0 left-1/2 w-0.5 sm:w-1 bg-yellow-300 transform -translate-x-1/2"></div>
                <div class="star absolute" style="top:20px; left:20px;"></div>
                <div class="star absolute" style="bottom:35px; right:20px; transform:scale(0.8);"></div>
                <div class="star absolute" style="top:50%; right:10px; transform:scale(0.6);"></div>
                <div class="absolute -bottom-2 sm:-bottom-4 left-1/2 transform -translate-x-1/2 w-44 h-6 sm:w-64 sm:h-8 bg-black opacity-30 blur-xl rounded-full"></div>
            </div>
        </div>

        <div id="chat-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 px-4">
            <div class="glass rounded-2xl p-4 shadow-2xl transform scale-0 transition-all duration-500 ease-out border-2 border-white/30 w-full max-w-md h-[80vh] flex flex-col" id="chat-box" style="transform: scale(0) translateY(100px);">
                
                <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2 drop-shadow">
                    <h3 class="text-white font-bold text-xl drop-shadow">Support - Elfen-Post ‚ú®</h3>
                    <button onclick="toggleChat(false)" class="text-white opacity-70 hover:opacity-100 transition-opacity p-1" aria-label="Chat minimieren">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M5 12h14"/></svg>
                    </button>
                </div>

                <div id="chat-messages" class="flex-grow overflow-y-auto space-y-3 p-2 custom-scrollbar">
                    </div>
                <div id="chat-buttons" class="mt-4 pt-4 border-t border-white/10 flex flex-wrap gap-3 justify-center">
                    </div>
            </div>
        </div>

        <div class="fixed inset-0 pointer-events-none" id="snow-container"></div>
    </div>

    <audio id="bg-music" loop preload="auto">
        <source src="dein_lied.mp3" type="audio/mpeg"> 
        Dein Browser unterst√ºtzt kein Audio-Tag.
    </audio>

    <div class="music-control" id="music-control" role="region" aria-label="Musik Steuerung">
        <button class="music-btn" id="music-toggle" title="Musik abspielen / pausieren" aria-label="Musik abspielen">
            <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            <svg id="icon-pause" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
        </button>
        <div style="display:flex;flex-direction:column;gap:4px;">
            <div class="music-title" id="music-title">Weihnachtsmusik</div>
            <div class="music-state" id="music-state">Pause</div>
        </div>
    </div>

    <div id="music-note" style="position:fixed;left:50%;transform:translateX(-50%);bottom:84px;background:rgba(0,0,0,0.6);color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;display:none;z-index:130;">Zum Starten antippen</div>

    <button id="chat-min-button" class="hidden fixed right-4 bottom-24 sm:right-8 sm:bottom-8 z-50 p-4 rounded-full bg-red-600 text-white shadow-xl transition-all duration-300 transform hover:scale-105" aria-label="Chat √∂ffnen" onclick="toggleChat(true)">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 15.15 15.15 0 0 1-5.65 6.4 15.24 15.24 0 0 1-4.4 1.45 8.38 8.38 0 0 1-6.1-2.9 8.38 8.38 0 0 1-2.9-6.1A8.44 8.44 0 0 1 2.5 12a8.38 8.38 0 0 1 3.8-.9 15.15 15.15 0 0 1 6.4-5.65 15.24 15.24 0 0 1 1.45-4.4A8.38 8.38 0 0 1 21 11.5z"/></svg>
    </button>

<script>
    // === Elemente & Konstanten ===
    const audio = document.getElementById('bg-music');
    const toggleBtn = document.getElementById('music-toggle');
    const iconPlay = document.getElementById('icon-play');
    const iconPause = document.getElementById('icon-pause');
    const musicState = document.getElementById('music-state');
    const musicNote = document.getElementById('music-note');
    const LS_PLAY_KEY = 'xmasMusicPlaying';
    audio.volume = 0.6;
    
    // Chat Elemente
    const chatMessages = document.getElementById('chat-messages');
    const chatButtons = document.getElementById('chat-buttons');
    
    // NEUE ELEMENTE F√úR MINIMIERUNG
    const chatModal = document.getElementById('chat-modal');
    const chatBox = document.getElementById('chat-box');
    const chatMinButton = document.getElementById('chat-min-button');

    // --- Neue Hilfsfunktion f√ºr explizite Pausen ---
    function pause(duration) {
        return new Promise(resolve => setTimeout(resolve, duration));
    }

    // --- Musik-Helfer (unver√§ndert) ---
    function updateToggleUI(isPlaying){
        if(isPlaying){ iconPlay.style.display='none'; iconPause.style.display='block'; musicState.textContent='Wiedergabe'; toggleBtn.setAttribute('aria-label','Musik pausieren'); }
        else { iconPlay.style.display='block'; iconPause.style.display='none'; musicState.textContent='Pause'; toggleBtn.setAttribute('aria-label','Musik abspielen'); }
    }
    function showStartHint(){ musicNote.style.display='block'; musicNote.style.opacity='1'; setTimeout(()=>{ musicNote.style.opacity='0'; }, 2200); setTimeout(()=>{ musicNote.style.display='none'; }, 2500); }
    function fadeAudioTo(targetVolume=0.6,duration=700){
        const start=audio.volume; const diff=targetVolume-start; const stepTime=40; const steps=Math.max(1,Math.floor(duration/stepTime)); let cur=0;
        const t=setInterval(()=>{ cur++; audio.volume = Math.min(1, Math.max(0, start + diff*(cur/steps))); if(cur>=steps) clearInterval(t); }, stepTime);
    }
    function fadeOutAndPause(duration=400){
        const start=audio.volume; const stepTime=40; const steps=Math.max(1,Math.floor(duration/stepTime)); let cur=0;
        const t=setInterval(()=>{ cur++; audio.volume = Math.max(0, start * (1 - cur/steps)); if(cur>=steps){ clearInterval(t); audio.pause(); } }, stepTime);
    }
    async function toggleMusic(userInitiated=true){
        if(audio.paused){
            try{
                await audio.play();
                if(userInitiated) fadeAudioTo(0.6,700);
                localStorage.setItem(LS_PLAY_KEY,'true');
                updateToggleUI(true);
            }catch(err){
                showStartHint();
                updateToggleUI(false);
                console.warn('Play blockiert:',err);
            }
        } else {
            fadeOutAndPause(400);
            localStorage.setItem(LS_PLAY_KEY,'false');
            updateToggleUI(false);
        }
    }
    toggleBtn.addEventListener('click', ()=> toggleMusic(true));
    function initMusic(){
        const shouldPlay = localStorage.getItem(LS_PLAY_KEY) === 'true';
        updateToggleUI(shouldPlay);
        if(shouldPlay){
            audio.play().then(()=> updateToggleUI(true)).catch(()=> { updateToggleUI(false); showStartHint(); });
        }
    }

    // --- Schneeflocken (unver√§ndert) ---
    function createSnowflake(){
        const snowflake = document.createElement('div');
        snowflake.className = 'snowflake';
        const left = Math.random() * 100;
        snowflake.style.left = left + '%';
        const size = Math.random() * 9 + 3;
        snowflake.style.width = size + 'px';
        snowflake.style.height = size + 'px';
        snowflake.style.opacity = (Math.random() * 0.4 + 0.4).toString();
        const dur = (4 + Math.random()*5).toFixed(2) + 's';
        snowflake.style.animationDuration = dur;
        snowflake.style.animationDelay = '0s';
        snowflake.style.animationTimingFunction = 'linear';
        document.getElementById('snow-container').appendChild(snowflake);
        setTimeout(()=> { snowflake.remove(); }, (parseFloat(dur) * 1000) + 500);
    }
    setInterval(createSnowflake, 200);

    // --- Konfetti (unver√§ndert) ---
    function confettiBurstFrom(originX, originY, count = 48) {
        const colors = ['#f59e0b','#fbbf24','#dc2626','#10b981','#fff1c2'];
        const confettis = [];
        for (let i = 0; i < count; i++) {
            const el = document.createElement('div');
            el.className = 'confetti';
            if (Math.random() > 0.78) el.style.borderRadius = '50%';
            else el.style.borderRadius = (2 + Math.random()*3) + 'px';
            const w = (6 + Math.random() * 12);
            const h = (8 + Math.random() * 16);
            el.style.width = w + 'px';
            el.style.height = h + 'px';
            el.style.background = colors[Math.floor(Math.random() * colors.length)];
            el.style.left = originX + 'px';
            el.style.top  = originY + 'px';
            el.style.position = 'fixed';
            el.style.zIndex = 10;
            el.style.opacity = '1';
            el.style.willChange = 'transform, opacity';
            document.body.appendChild(el);
            const angle = (-125 + Math.random() * 70) * (Math.PI / 180);
            const speed = 600 + Math.random() * 400;
            const vx = Math.cos(angle) * speed;
            const vy = Math.sin(angle) * speed;
            const rot = Math.random() * 360;
            const rotV = (Math.random() * 600 - 300);
            confettis.push({
                el,
                x: originX,
                y: originY,
                vx, vy,
                rot, rotV,
                birth: performance.now(),
                life: 0
            });
        }
        const gravity = 1200;
        let last = performance.now();
        function frame(now) {
            const dtMs = now - last;
            last = now;
            const dt = dtMs / 1000;
            for (let i = confettis.length - 1; i >= 0; i--) {
                const p = confettis[i];
                p.vy += gravity * dt;
                p.x += p.vx * dt;
                p.y += p.vy * dt;
                p.rot += p.rotV * dt;
                p.life += dt;
                const tx = p.x - (p.el._originX ?? p.x);
                const ty = p.y - (p.el._originY ?? p.y);
                p.el.style.transform = `translate(${p.x - originX}px, ${p.y - originY}px) rotate(${p.rot}deg)`;
                if (p.life > 2.4) {
                    const fade = Math.max(0, 1 - (p.life - 2.4) / 1.4);
                    p.el.style.opacity = String(fade);
                }
                if (p.y > window.innerHeight + 200 || p.life > 6) {
                    p.el.remove();
                    confettis.splice(i, 1);
                }
            }
            if (confettis.length > 0) requestAnimationFrame(frame);
        }
        requestAnimationFrame(frame);
    }

    // === INTERAKTIVER CHAT FUNKTIONALIT√ÑT ===

    // NEUE FUNKTION: Minimieren und Maximieren des Chats
    function toggleChat(maximize) {
        if (maximize) {
            // Maximieren: zeige Modal, verstecke Minimier-Button
            chatModal.classList.remove('hidden');
            // Timeout, damit 'hidden' entfernt ist, bevor die Animation startet
            setTimeout(() => {
                chatBox.style.transform = 'scale(1) translateY(0)';
            }, 30);
            chatMinButton.classList.add('hidden');
        } else {
            // Minimieren: starte Schlie√ü-Animation, zeige Minimier-Button
            chatBox.style.transform = 'scale(0) translateY(100px)';
            
            // Warte auf Animationsende, dann verstecke den Container
            setTimeout(() => {
                chatModal.classList.add('hidden');
                chatMinButton.classList.remove('hidden');
            }, 500); // Passt zur transition-all Dauer in der CSS
        }
    }


    // F√ºgt eine Nachricht in den Chat ein (mit Markdown- und Zeilenumbruch-Support)
    function addChatMessage(messageObj, container, delay=0){
        return new Promise(resolve => {
            setTimeout(() => {
                const isMe = messageObj.sender === 'me';
                const wrapper = document.createElement('div');
                wrapper.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;

                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${isMe ? 'bubble-me' : 'bubble-other'}`;
                
                let htmlContent = messageObj.text;
                
                // 0. KORRIGIERT: Line breaks (\\n) zu <br>
                htmlContent = htmlContent.replace(/\\n/g, '<br>');

                // 1. Fett (**text**) -> <b>text</b>
                htmlContent = htmlContent.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                // 2. Kursiv (*text*) -> <i>text</i>
                htmlContent = htmlContent.replace(/\*(.*?)\*/g, '<i>$1</i>');

                bubble.innerHTML = htmlContent; // Verwende innerHTML f√ºr HTML-Formatierung

                wrapper.appendChild(bubble);
                container.appendChild(wrapper);

                // Autoscroll zum neuesten Element
                container.scrollTop = container.scrollHeight;
                resolve();
            }, delay);
        });
    }

    // F√ºgt interaktive Buttons hinzu (KORRIGIERT F√úR SCROLLING)
    function addChatButtons(buttons, container, handler) {
        container.innerHTML = '';
        buttons.forEach(btn => {
            const button = document.createElement('button');
            button.className = 'px-4 py-2 rounded-full font-semibold text-sm transition-all duration-300 transform hover:scale-105 shadow-lg bg-white/10 text-white hover:bg-white/20 backdrop-filter backdrop-blur-sm';
            button.textContent = btn.text;
            
            button.onclick = () => {
                // Deaktiviert alle Buttons
                container.querySelectorAll('button').forEach(b => {
                    b.disabled = true;
                    b.classList.add('opacity-50', 'cursor-not-allowed');
                    b.classList.remove('hover:scale-105', 'hover:bg-white/20');
                });

                // F√ºgt die geklickte Option als Benutzer-Nachricht hinzu
                addChatMessage({ sender: 'me', delay: 0, text: btn.text }, chatMessages);

                // Wechselt zur n√§chsten Stufe
                setTimeout(() => handler(btn.nextStage), 500);
            };
            container.appendChild(button);
        });

        // WICHTIGE KORREKTUR: Erzwinge Scrollen der Nachrichten, nachdem die Buttons 
        // (die Platz am unteren Rand beanspruchen) hinzugef√ºgt wurden.
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Steuert den Chat-Verlauf basierend auf Stages (MIT PAUSEN F√úR BESSEREN FLOW)
    async function handleChatStage(stage) {
        chatButtons.innerHTML = ''; // Buttons entfernen, w√§hrend Bilbo antwortet

        switch (stage) {
            case 'START':
                addChatMessage({ sender: 'other', delay: 800, text: "Ho Ho Ho! Hier spricht *Bilbo* vom **Team der Elfen-Post** des Weihnachtsmanns. Deine Verbindung war etwas holprig, aber ich bin hier! Wie kann ich dir im vorweihnachtlichen Chaos beistehen?" }, chatMessages).then(() => {
                    addChatButtons([
                        { text: "Suche mein Geschenk!", nextStage: 'ASK_PROMISE' },
                        { text: "Ich brauche Hilfe beim Pl√§tzchenbacken.", nextStage: 'FALLBACK_1' }
                    ], chatButtons, handleChatStage);
                });
                break;

            case 'ASK_PROMISE':
                addChatMessage({ sender: 'other', delay: 1500, text: "Wunderbar! Bevor wir zur Geschenke-√úbergabe √ºbergehen, eine wichtige Formalit√§t (Boss-Anweisung!): Versprichst du mir, zuk√ºnftige Geschenke **NICHT** immer komplett einzeln zu verpacken (denkt denn niemand an das Geschenkpapier-Lager?!) und nat√ºrlich *lieb* zu sein? üòâ" }, chatMessages).then(() => {
                    addChatButtons([
                        { text: "Ja, versprochen! F√ºr das Papier-Lager!", nextStage: 'SUCCESS' },
                        { text: "Nein, ich liebe das Chaos.", nextStage: 'FALLBACK_2' }
                    ], chatButtons, handleChatStage);
                });
                break;

            case 'SUCCESS':
                // Sequenz: Nachricht 1 -> Pause -> Nachricht 2
                addChatMessage({ sender: 'other', delay: 1200, text: "Perfekt, dein Versprechen ist im goldenen Buch registriert. Wir hoffen sehr du h√§lst dein Versprechen!" }, chatMessages)
                .then(() => pause(2500)) // **Wartezeit erh√∂ht und explizit**
                .then(() => addChatMessage({ sender: 'other', delay: 100, text: "Schau am besten *noch einmal* unter den Baum... Vielleicht ist es an den falschen Empf√§nger addressiert. üêæ Ich w√ºnsche dir magische Feiertage und frohe Weihnachten! Tsch√ºss und bis n√§chstes Jahr! üéÑ" }, chatMessages));
                break;

            case 'FALLBACK_1':
                // Sequenz: Nachricht 1 -> Pause -> Nachricht 2 -> Buttons
                addChatMessage({ sender: 'other', delay: 1000, text: "Uff, mein Fachgebiet ist die *globale Nordpol-Logistik* ‚Äì die K√ºche ist eher Trixis Revier! Aber warte mal, ich habe hier einen Zettel..." }, chatMessages)
                .then(() => pause(1800)) // **Explizite Pause**
                .then(() => addChatMessage({ sender: 'other', delay: 100, text: "Ah, Trixi hat mir ihr super-geheimes Rezept f√ºr *Blitz-Vanillekipferl* zugesteckt. M√∂chtest du es lieber sehen, oder gleich das Geschenk suchen?" }, chatMessages))
                .then(() => {
                    addChatButtons([
                        { text: "Trixis Rezept √∂ffnen", nextStage: 'RECIPE' },
                        { text: "Zur√ºck zum Geschenk-Support", nextStage: 'START' }
                    ], chatButtons, handleChatStage);
                });
                break;
                
            case 'RECIPE':
                // Synchronen Aufruf zuerst ausf√ºhren (funktioniert, da es kein Promise zur√ºckgibt)
                window.open("https://www.chefkoch.de/rezepte/403911129675192/Uromas-Vanillekipferl.html","_blank");
                
                // Asynchrone Kette mit der Pause starten
                pause(1800) // Explizite Pause nach dem √ñffnen des Fensters
                .then(() => addChatMessage({ sender: 'other', delay: 100, text: "Nun aber schnell zur√ºck zum Geschenk! Die Zeit dr√§ngt! üéÅ" }, chatMessages))
                .then(() => {
                    addChatButtons([
                        { text: "Zum Geschenke-Versprechen", nextStage: 'ASK_PROMISE' }
                    ], chatButtons, handleChatStage);
                });
                break;

            case 'FALLBACK_2':
            addChatMessage({ sender: 'other', delay: 1000, text: "Das kann ich leider nicht akzeptieren, wir sind hier schlie√ülich nicht in der Chaos-Abteilung. Ohne das Versprechen kann ich die Route nicht freigeben. √úberdenke deine Antwort. üéÅ" }, chatMessages).then(() => {
                addChatButtons([
                    { text: "Ich √ºberlege es mir anders...", nextStage: 'ASK_PROMISE' }
                ], chatButtons, handleChatStage);
            });
            break;
        }
    }


    // === Geschenk √∂ffnen (Angepasst f√ºr sanften √úbergang) ===
    let isOpen = false;
    async function openGift(){
        if(isOpen) return;
        isOpen = true;

        const lid = document.getElementById('gift-lid');
        const box = document.getElementById('gift-box');
        const bowLeft = document.getElementById('bow-left');
        const bowRight = document.getElementById('bow-right');
        const bowCenter = document.getElementById('bow-center');
        const giftContainer = document.getElementById('gift-container');

        // Nutzeraktion: starte Musik falls pausiert
        toggleMusic(true);

        // 1. kurz sch√ºtteln
        giftContainer.classList.add('shake');
        setTimeout(()=> giftContainer.classList.remove('shake'), 600);

        // 2. √ñffnen-Bows
        setTimeout(()=>{
            bowLeft.classList.add('open-bow-left');
            bowRight.classList.add('open-bow-right');
            bowCenter.classList.add('open-bow-center');
        }, 300);

        // 3. Deckel √∂ffnen & Konfetti
        setTimeout(()=>{
            lid.classList.add('open-lid');

            // Konfetti aus der Box schie√üen
            setTimeout(()=> {
                const rect = box.getBoundingClientRect();
                const originX = Math.round(rect.left + rect.width/2);
                const originY = Math.round(rect.top + rect.height*0.05);
                confettiBurstFrom(originX, originY, 64);
            },600);
            
            // 4. Geschenk wegbewegen & Chat-Modal anzeigen und Chat-Dialog starten
            setTimeout(()=> {
                // Geschenk sanft ausblenden und nach unten schieben
                giftContainer.style.opacity = '0';
                giftContainer.style.transform = 'translateY(150px) scale(0.9)';

                // Starte den interaktiven Chat-Dialog (Maximiert)
                toggleChat(true); 
                handleChatStage('START');
            }, 1500); 

        }, 700);
    }

    // === On load & keyboard (unver√§ndert) ===
    window.addEventListener('keydown', (e)=>{
        if(e.code === 'Space' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA'){
            e.preventDefault();
            toggleMusic(false);
        }
    });

    document.addEventListener('DOMContentLoaded', ()=>{
        initMusic();
        document.body.addEventListener('click', ()=> {
            const shouldPlay = localStorage.getItem(LS_PLAY_KEY) === 'true';
            if(shouldPlay && audio.paused){
                audio.play().then(()=> {}).catch(()=> showStartHint());
            }
        });
    });
</script>
</body>
</html>